---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggthemes)
library(feather)
library(lubridate)
```

```{r}
df <- read_csv("../data/Compassion_14 November 2021_16.36.csv")
df
```

```{r}
df <- df %>% 
  slice(3:n()) %>% 
  mutate(StartDate = as.Date(StartDate)) %>% 
  filter(StartDate >= ymd("2021-01-02"))
```



```{r}
responses <- df %>% 
  select(
    ResponseId,
    starts_with("SOCS")
)

responses
```

```{r}
ordered_responses <- responses %>% 
  mutate(across(starts_with("SOCS"), ~if_else(is.na(.), ., str_extract(., "\\d$")))) %>% 
  pivot_longer(starts_with("SOCS"), names_to = "item", values_to = "response") %>% 
  mutate(response = ordered(response, levels = c("1", "2", "3", "4", "5")))

ordered_responses
```

```{r}
ordered_responses %>% 
  write_feather("../results/tidy_responses.feather")
```



```{r, fig.width=16, fig.height=9}
ggplot(ordered_responses, aes(x=response)) +
  geom_bar(stat = "count") +
  facet_wrap(~item, ncol = 10) +
  theme_few()
```

Looks like very few people fell for SOCS-O 5 (The attention check.) I'm going to remove this item and and anyone who didn't respond to it.

```{r}
filtered_responses <- responses %>% 
  mutate(across(-ResponseId, ~if_else(is.na(.), ., str_extract(., "\\d$")))) %>% 
  filter(`SOCS-O_5` == "5") %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = ordered(response, levels = c("1", "2", "3", "4", "5"))) %>% 
  filter(item != "SOCS-O_5")
```

```{r, fig.width=16, fig.height=9}
ggplot(filtered_responses, aes(x=response)) +
  geom_bar(stat = "count") +
  facet_wrap(~item, ncol = 10) +
  theme_few()
```


```{r}
filtered_responses %>% 
  write_feather("../results/tidy_filtered_responses.feather")
```

```{r}
demographics <- df %>% 
  select(ResponseId, starts_with("DEM")) %>% 
  pivot_longer(-ResponseId, names_to = "dem_item", values_to = "dem_value", values_drop_na=TRUE)

demographics
```

```{r}
demographics %>% 
  write_feather("../results/tidy_demographics.feather")
```

```{r}
socs_scales <- filtered_responses %>%
  mutate(scale_type = str_extract(item, "SOCS-[A-Z]")) %>% 
  mutate(response = as.numeric(response)) %>% 
  group_by(ResponseId, scale_type) %>% 
  summarise(socs_total = sum(response)) %>% 
  pivot_wider(ResponseId, names_from = scale_type, values_from = socs_total)

socs_scales
```

```{r}
socs_scales %>% 
  write_feather("../results/socs_scales.feather")
```

### PBIS

```{r}
tidy_pbis <- df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("PBIS")) %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = as.numeric(str_extract(response, "\\d$")))

tidy_pbis
```
```{r}
tidy_pbis %>% 
  write_feather("../results/tidy_pbis.feather")
```

```{r}
pbis_scales <- tidy_pbis %>% 
  group_by(ResponseId) %>% 
  summarise(PBIS = sum(response))

pbis_scales
```

```{r}
pbis_scales %>% 
  write_feather("../results/pbis_scales.feather")
```

### CS

```{r}
tidy_cs <- df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("CS")) %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = as.numeric(str_extract(response, "\\d$")))

tidy_cs
```
```{r}
tidy_cs %>% 
  write_feather("../results/tidy_cs.feather")
```

```{r}
cs_scales <- tidy_cs %>% 
  group_by(ResponseId) %>% 
  summarise(CS = sum(response))

cs_scales
```

```{r}
cs_scales %>% 
  write_feather("../results/cs_scales.feather")
```

### WEMWBS

```{r}
tidy_wemwbs <- df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("WEMWBS")) %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = case_when(
    response == "Jamais" ~ 1,
    response == "Rarement" ~ 2,
    response == "Parfois" ~ 3,
    response == "Souvent" ~ 4,
    response == "Tout le temps" ~ 5,
    TRUE ~ NA_real_
  ))

tidy_wemwbs
```

Jamais = Never
Rarement = Rarely
Parfois = Sometimes
Souvent = Often
Tout le temps = All the time

```{r}
tidy_wemwbs %>% 
  write_feather("../results/tidy_wemwbs.feather")
```

```{r}
wemwbs_scales <- tidy_wemwbs %>% 
  group_by(ResponseId) %>% 
  summarise(WEMWBS = sum(response))

wemwbs_scales
```

```{r}
wemwbs_scales %>% 
  write_feather("../results/wemwbs_scales.feather")
```

### SCS

```{r}
tidy_scs <- df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("SCS")) %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = as.numeric(str_extract(response, "\\d$")))

tidy_scs
```
```{r}
tidy_scs %>% 
  write_feather("../results/tidy_scs.feather")
```

```{r}
scs_scales <- tidy_scs %>% 
  group_by(ResponseId) %>% 
  summarise(SCS = sum(response))

scs_scales
```

```{r}
scs_scales %>% 
  write_feather("../results/scs_scales.feather")
```

### CEAS-SC

```{r}
tidy_ceas_sc <- df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("CEAS-SC")) %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = as.numeric(str_extract(response, "\\d+$")))

tidy_ceas_sc
```


### FFMQ

```{r}
tidy_ffmq <- df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("FFMQ")) %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = case_when(
    response == "Jamais ou très rarement vrai" ~ 1,
    response == "Rarement vrai" ~ 2,
    response == "Parfois vrai" ~ 3,
    response == "Souvent vrai" ~ 4,
    response == "Très souvent ou toujours vrai" ~ 5,
    TRUE ~ NA_real_
  ))

tidy_ffmq
```
Jamais ou très rarement vrai = Never or very rarely true
Rarement vrai = Rarely true
Parfois vrai = Sometimes true
Souvent vrai = Often true
Très souvent ou toujours vrai = Very often or always true

```{r}
tidy_ffmq %>% 
  write_feather("../results/tidy_ffmq.feather")
```

```{r}
ffmq_scales <- tidy_ffmq %>% 
  group_by(ResponseId) %>% 
  summarise(FFMQ = sum(response))

ffmq_scales
```

```{r}
ffmq_scales %>% 
  write_feather("../results/ffmq_scales.feather")
```

Look at attention checks:

```{r}
df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("FFMQ")) %>% 
  filter(FFMQ_12 != "Parfois vrai")
```

### ECR

```{r}
tidy_ecr <- df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("ECR")) %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = as.numeric(str_extract(response, "\\d$")))

tidy_ecr
```

```{r}
tidy_ecr %>% 
  write_feather("../results/tidy_ecr.feather")
```

```{r}
ecr_scales <- tidy_ecr %>% 
  group_by(ResponseId) %>% 
  summarise(ECR = sum(response))

ecr_scales
```

```{r}
ecr_scales %>% 
  write_feather("../results/ecr_scales.feather")
```


### DASS

```{r}
tidy_dass <- df %>% 
  semi_join(socs_scales) %>% 
  select(ResponseId, starts_with("DASS")) %>% 
  pivot_longer(-ResponseId, names_to = "item", values_to = "response") %>% 
  mutate(response = as.numeric(str_extract(response, "\\d$")))

tidy_dass
```

```{r}
tidy_dass %>% 
  write_feather("../results/tidy_dass.feather")
```

```{r}
dass_scales <- tidy_dass %>% 
  group_by(ResponseId) %>% 
  summarise(DASS = sum(response))

dass_scales
```

```{r}
dass_scales %>% 
  write_feather("../results/dass_scales.feather")
```

```{r}
devtools::session_info()
```

