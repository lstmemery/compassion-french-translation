---
title: "scale_correlations"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(feather)
library(purrr)
library(ggcorrplot)
library(viridis)
library(jtools)
library(MESS)
library(psych)
```

```{r}
all_scales <- map_dfr(Sys.glob(file.path("../results/", "*_scales.feather")), read_feather) %>% 
  pivot_longer(-ResponseId, values_drop_na = TRUE) %>% 
  pivot_wider(ResponseId)

all_scales
```

```{r}
df_cor <- cor(all_scales %>% select(-ResponseId), use="pairwise.complete.obs", method="spearman")

cor_row_names <- row.names(df_cor)

df_cor %>% 
  as_tibble() %>% 
  mutate(row_name = cor_row_names)
  # filter(str_detect(row_name, "SOCS")) %>% 
  # select(row_name, !contains("SOCS"))
```

```{r, fig.width=16/4, fig.height=9/4}
ggcorrplot(cor(all_scales %>% select(-ResponseId), use="pairwise.complete.obs", method="spearman"),
           type = "upper", hc.order = TRUE, lab=TRUE)
```

```{r}
all_scale_cor <- corr.test(all_scales %>% select(-ResponseId))
  


clean_cor <- all_scale_cor$r %>% 
  as_tibble() %>% 
  mutate_all(~round(., 2)) %>% 
  mutate(row_name = cor_row_names)
  # filter(str_detect(row_name, "SOCS")) %>% 
  # select(row_name, CEAS_FROM, CEAS_S, CEAS_TO, CS_Total, DASS_21_Total, ECR_Total, FFMQ_Total, PBIS, SCS_Positive = Positive, SCS_Negative = Negative)
```

```{r}
p_values <- all_scale_cor$p %>% 
  as_tibble() 
  # mutate(row_name = cor_row_names)
  # filter(str_detect(row_name, "SOCS")) %>% 
  # select(row_name, CEAS_FROM, CEAS_S, CEAS_TO, CS_Total, DASS_21_Total, ECR_Total, FFMQ_Total, PBIS, SCS_Positive = Positive, SCS_Negative = Negative)

p_col <- ncol(p_values)
p_row <- nrow(p_values)

p_stars <- p_values %>% 
  mutate(across(where(is.numeric), ~p.adjust(., method="BH", n=p_col * p_row))) %>% 
  mutate(across(where(is.numeric), ~case_when(
    . > 0.05 ~ "",
    . > 0.01 ~ "*",
    . > 0.001 ~ "**",
    TRUE ~ "***"
    )))
```

```{r}
results <- map_dfc(cor_row_names, ~paste0(clean_cor[[.]], p_stars[[.]]))
colnames(results) <- cor_row_names
final_results <- results %>% 
  mutate(Scale = cor_row_names) %>% 
  select(Scale, everything())
```

```{r}
final_results %>% 
  write_csv("../results/scale_correlation.csv")
```

### Scale-Only adjustment

```{r}
major_scales <- all_scales %>% 
  select(CEAS_FROM, CEAS_S, CEAS_TO, CS_Total, `SOCS-O`, `SOCS-S`, DASS_21_Total, ECR_Total, FFMQ_Total, SCS_Negative = Negative, SCS_Positive = Positive, WEMWBS)

major_cor_names <- colnames(major_scales)

```

```{r}
major_scale_cor <- corr.test(major_scales, adjust = "BH")
major_scale_cor
```

```{r}
major_scale_stars <- major_scale_cor$stars %>% 
  as_data_frame() %>% 
  mutate(Scale = major_cor_names) %>% 
  select(Scale, everything())
```

```{r}
major_scale_stars %>% 
  write_csv("../results/major_scale_correlation.csv")
```

### Means and Standard Deviations

```{r}
scale_means <- all_scales %>% 
  pivot_longer(-ResponseId) %>% 
  group_by(name) %>% 
  summarise(
    scale_mean = mean(value, na.rm=TRUE),
    scale_sd = sd(value, na.rm=TRUE),
    scale_min = min(value, na.rm=TRUE),
    scale_max = max(value, na.rm=TRUE)
    )
scale_means
```

```{r}
scale_means %>% 
  write_csv("../results/scale_means.csv")
```

```{r}
devtools::session_info()
```
