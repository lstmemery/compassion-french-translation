---
title: "PBIS CFAs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(feather)
library(psych)
source("funcs.R")
```

```{r}
pbis <- read_feather("../results/tidy_pbis.feather")
```

```{r}
pbis_wide <- pbis %>% 
  pivot_wider(values_from = response, id_cols = ResponseId, names_from = item) %>% 
  filter_all(all_vars(!is.na(.))) 
```

```{r, correlation}
pbis <- polychoric(pbis_wide)
```

```{r, fig.width=16/2, fig.height=9/2}
format_correlation(pbis$rho, "PBIS Polychoric")
```

```{r}
eigen(pbis$rho)$values
```

```{r}
scale_name <- "PBIS"
df <- pbis_wide
```

## One-factor model

```{r}
model_name <- "One Factor"
model_string <- "compassion =~ PBIS_1 + PBIS_2 + PBIS_3 + PBIS_4"
model_string
```

```{r}
cfa_fit <- fit_cfa(model_string, df)
```

```{r}
model_fit_model <- fitmeasures(cfa_fit)
```

```{r}
cfa_fit <- cfa(
    model_string, 
    data=df,
    estimator="MLR",
    
    std.lv=TRUE
  )
summary(cfa_fit)
fitmeasures(cfa_fit)
```

```{r}
fit_measure <- lav_fit_measures(cfa_fit, df, scale_name, model_name)
format_huxtable(fit_measure)
```

```{r}
format_sem_paths(cfa_fit, scale_name, model_name)
```

```{r}
format_huxtable(format_cfa_parameters(cfa_fit))
```

```{r}
pbis_one_fit <- fit_measure
```

```{r}
sessionInfo()
```
